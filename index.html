<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>韓国語学習 4択クイズ</title>

<style>
html, body {
  margin:0; padding:0;
  height:100%;
  font-family: -apple-system,BlinkMacSystemFont,sans-serif;
  background:#e0f7fa;
  overflow:hidden;
}

/* 共通スクリーン */
.screen {
  position: fixed;
  inset:0;
  padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
  box-sizing: border-box;
  display:none;
  z-index:10;
}

/* モード選択 */
#modeSelect {
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:24px;
}
.mode-btn {
  font-size:26px;
  padding:24px;
  border-radius:16px;
  border:none;
  background:#81d4fa;
  color:#033;
  box-shadow:0 4px 6px rgba(0,0,0,.25);
}
.mode-btn:active { transform: scale(.95); }

/* チャプター選択 */
#chapterSelect {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px;
}
.chapter-btn {
  width:60px; height:60px;
  font-size:20px;
  border-radius:12px;
  border:none;
  background:#81d4fa;
  color:#033;
  box-shadow:0 3px 5px rgba(0,0,0,0.2);
}
.chapter-btn.pink { background:#f8bbd0; } /* 直前学習 */
.chapter-btn.lightblue { background:#b2ebf2; } /* 遊んだチャプター */
.chapter-btn.gold { background:#ffd700; } /* 全問正解 */
.chapter-btn:active { transform: scale(.94); }

/* クイズ画面 */
#quizWord {
  font-size:36px;
  text-align:center;
  margin:20px 0;
  padding:16px;
  border-radius:12px;
  background:#b2ebf2;
}

#choices {
  display:grid;
  gap:12px;
}

.choice {
  font-size:18px;
  padding:14px;
  border-radius:12px;
  border:none;
  background:#fff;
  box-shadow:0 3px 5px rgba(0,0,0,.2);
}
.choice.correct { background:#b9f6ca; }
.choice.wrong { background:#ffcdd2; }

/* 結果画面 */
#resultList {
  display:flex;
  flex-direction:column;
  gap:6px;
  margin:12px 0;
}
.resultItem.correct { color:green; }
.resultItem.wrong { color:red; }

button { cursor:pointer; font-family:inherit; }
</style>
</head>

<body>

<!-- モード選択 -->
<div id="modeSelect" class="screen" style="display:flex">
  <button class="mode-btn" onclick="startFlash()">フラッシュカード</button>
  <button class="mode-btn" onclick="showChapterSelect()">4択クイズ</button>
</div>

<!-- チャプター選択 -->
<div id="chapterSelect" class="screen"></div>

<!-- クイズ画面 -->
<div id="quiz" class="screen">
  <div id="quizWord"></div>
  <div id="choices"></div>
</div>

<!-- 結果画面 -->
<div id="result" class="screen">
  <h3>チャプター結果</h3>
  <div id="resultList"></div>
  <button onclick="retryChapter()">もう一度</button>
  <button onclick="backToChapterSelect()">チャプター選択に戻る</button>
</div>

<script>
let words = [];
let chapters = [];
let currentChapterIndex = 0;
let currentQuestionIndex = 0;
let currentChapter = [];
let answersRecord = [];

/* CSV 読み込み */
fetch("words.csv")
  .then(r=>r.text())
  .then(txt=>{
    words = txt.trim().split("\n").map(l=>l.split(",")).filter(w=>w.length>=2);
    // 10問ごとにチャプター分け
    for(let i=0;i<words.length;i+=10){
      chapters.push(words.slice(i,i+10));
    }
  });

/* ===== モード切替 ===== */
function hideAll(){ document.querySelectorAll(".screen").forEach(s=>s.style.display="none"); }

function startFlash(){
  hideAll();
  alert("※ フラッシュカードは既存実装を使用してください");
}

function showChapterSelect(){
  hideAll();
  const div = document.getElementById("chapterSelect");
  div.innerHTML="";
  chapters.forEach((ch,i)=>{
    const b = document.createElement("button");
    b.className="chapter-btn";
    b.textContent=i+1;
    b.onclick=()=>startChapter(i);
    div.appendChild(b);
  });
  div.style.display="flex";
}

/* ===== チャプター開始 ===== */
function startChapter(i){
  currentChapterIndex=i;
  currentChapter=chapters[i];
  currentQuestionIndex=0;
  answersRecord=[];
  hideAll();
  document.getElementById("quiz").style.display="block";
  renderQuestion();
}

/* ===== クイズ描画 ===== */
function renderQuestion(){
  const q = currentChapter[currentQuestionIndex];
  const wordDiv=document.getElementById("quizWord");
  wordDiv.textContent=q[0];

  let choices=[q[1]];
  while(choices.length<4){
    const w = words[Math.floor(Math.random()*words.length)][1];
    if(!choices.includes(w)) choices.push(w);
  }
  choices.sort(()=>Math.random()-0.5);

  const box=document.getElementById("choices");
  box.innerHTML="";

  choices.forEach(c=>{
    const b=document.createElement("button");
    b.className="choice";
    b.textContent=c;
    b.onclick=()=>checkAnswer(b,c===q[1]);
    box.appendChild(b);
  });
}

/* ===== 回答チェック ===== */
function checkAnswer(btn, correct){
  document.querySelectorAll(".choice").forEach(b=>b.disabled=true);
  btn.classList.add(correct?"correct":"wrong");
  answersRecord.push(correct);

  // 正解をハイライト
  if(!correct){
    document.querySelectorAll(".choice").forEach(b=>{
      if(b.textContent===currentChapter[currentQuestionIndex][1])
        b.classList.add("correct");
    });
  }

  setTimeout(()=>{
    currentQuestionIndex++;
    if(currentQuestionIndex<currentChapter.length){
      renderQuestion();
    } else {
      showResult();
    }
  },700);
}

/* ===== 結果画面 ===== */
function showResult(){
  hideAll();
  const resDiv=document.getElementById("result");
  const listDiv=document.getElementById("resultList");
  listDiv.innerHTML="";
  answersRecord.forEach((v,i)=>{
    const d=document.createElement("div");
    d.className="resultItem "+(v?"correct":"wrong");
    d.textContent=(i+1)+". "+currentChapter[i][0]+" → "+currentChapter[i][1]+" : "+(v?"正解":"不正解");
    listDiv.appendChild(d);
  });
  resDiv.style.display="block";

  // チャプターボタンに色を反映
  const chapterBtn=document.querySelectorAll(".chapter-btn")[currentChapterIndex];
  if(answersRecord.every(v=>v)) chapterBtn.classList.add("gold");
  else chapterBtn.classList.add("lightblue");
}

/* ===== ボタン ===== */
function retryChapter(){
  startChapter(currentChapterIndex);
}

function backToChapterSelect(){
  showChapterSelect();
}

</script>

</body>
</html>