<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>韓国語4択クイズ</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #e0f7fa;
  overflow: hidden;
}

.screen { position: fixed; inset: 0; padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom); box-sizing: border-box; display: none; }

#modeSelect { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 24px; }
.mode-btn { font-size: 26px; padding: 24px; border-radius: 16px; border: none; background: #81d4fa; color: #033; box-shadow: 0 4px 6px rgba(0,0,0,.25); width: 80%; }
.mode-btn:active { transform: scale(.95); }

/* チャプター選択 */
#chapterSelect { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; overflow-y: auto; padding-bottom: 80px; }
.chapter-btn { aspect-ratio: 1/1; font-size: 20px; border-radius: 12px; border: none; background: #81d4fa; color: #033; box-shadow:0 3px 5px rgba(0,0,0,0.2);}
.chapter-btn:active { transform: scale(0.94); }

/* クイズ画面 */
#quizWord { font-size: 36px; text-align: center; margin: 40px 0; background: #b2ebf2; padding: 20px; border-radius: 16px; }
#choices { display: grid; grid-template-columns: 1fr; gap: 14px; }
.choice { font-size: 20px; padding: 16px; border-radius: 12px; border: none; background: #fff; box-shadow: 0 3px 5px rgba(0,0,0,.2);}
.choice.correct { background: #b9f6ca; }
.choice.wrong { background: #ffcdd2; }

/* 振り返り画面 */
#reviewList { display: grid; grid-template-columns: 1fr; gap: 6px; margin: 20px 0; }
.reviewItem.correct { color: #388e3c; }
.reviewItem.wrong { color: #d32f2f; }

button { cursor: pointer; }
#quizBack, #reviewBack, #reviewRetry { margin-top: 10px; font-size: 20px; padding: 12px 16px; border-radius: 12px; border: none; background: #81d4fa; color: #033; box-shadow:0 3px 5px rgba(0,0,0,0.2);}
#quizBack:active, #reviewBack:active, #reviewRetry:active { transform: scale(0.95); }

</style>
</head>
<body>

<!-- モード選択 -->
<div id="modeSelect" class="screen" style="display:flex">
  <button class="mode-btn" onclick="startFlash()">フラッシュカード</button>
  <button class="mode-btn" onclick="showChapterSelect()">4択クイズ</button>
</div>

<!-- チャプター選択 -->
<div id="chapterSelect" class="screen"></div>

<!-- クイズ画面 -->
<div id="quiz" class="screen">
  <div id="quizWord"></div>
  <div id="choices"></div>
  <button id="quizBack" onclick="backToChapterSelect()">もどる</button>
</div>

<!-- 振り返り画面 -->
<div id="review" class="screen">
  <h2>振り返り</h2>
  <div id="reviewList"></div>
  <button id="reviewRetry" onclick="retryChapter()">もう一度</button>
  <button id="reviewBack" onclick="backToChapterSelect()">チャプターに戻る</button>
</div>

<script>
let words = [];
let chapters = [];
let currentChapter = [];
let chapterIndex = 0;
let quizIndex = 0;
let reviewData = [];

// CSV読み込み
fetch("words.csv")
  .then(r => r.text())
  .then(text => {
    words = text.trim().split("\n").map(l=>l.split(",")).filter(w=>w.length>=2);
    // 10問ごとにチャプター分割
    for(let i=0;i<words.length;i+=10){
      chapters.push(words.slice(i,i+10));
    }
  });

// 表示制御
function hideAll(){ document.querySelectorAll(".screen").forEach(s=>s.style.display="none"); }

// モード選択
function startFlash(){ alert("フラッシュカードは既存実装を使用してください"); }

// チャプター選択画面
function showChapterSelect(){
  hideAll();
  const div = document.getElementById("chapterSelect");
  div.innerHTML = "";
  chapters.forEach((c,i)=>{
    const b = document.createElement("button");
    b.textContent = i+1;
    b.className = "chapter-btn";
    b.onclick = ()=>startChapter(i);
    div.appendChild(b);
  });
  div.style.display="grid";
}

// チャプター開始
function startChapter(idx){
  chapterIndex = idx;
  currentChapter = chapters[idx];
  quizIndex = 0;
  reviewData = [];
  hideAll();
  document.getElementById("quiz").style.display="block";
  showQuiz();
}

// クイズ表示
function showQuiz(){
  const q = currentChapter[quizIndex];
  document.getElementById("quizWord").textContent = q[0];
  // 4択生成
  let choices = [q[1]];
  while(choices.length<4){
    const w = words[Math.floor(Math.random()*words.length)][1];
    if(!choices.includes(w)) choices.push(w);
  }
  choices.sort(()=>Math.random()-0.5);
  const box = document.getElementById("choices");
  box.innerHTML="";
  choices.forEach(c=>{
    const b = document.createElement("button");
    b.className="choice";
    b.textContent=c;
    b.onclick=()=>checkAnswer(b,c===q[1]);
    box.appendChild(b);
  });
}

// 回答処理
function checkAnswer(btn, correct){
  document.querySelectorAll(".choice").forEach(b=>b.disabled=true);
  reviewData.push(correct);
  btn.classList.add(correct?"correct":"wrong");
  if(!correct){
    document.querySelectorAll(".choice").forEach(b=>{
      if(b.textContent===currentChapter[quizIndex][1])
        b.classList.add("correct");
    });
  }
  setTimeout(()=>{
    quizIndex++;
    if(quizIndex<currentChapter.length){
      showQuiz();
    }else{
      showReview();
    }
  },800);
}

// 振り返り画面
function showReview(){
  hideAll();
  const div = document.getElementById("reviewList");
  div.innerHTML="";
  reviewData.forEach((r,i)=>{
    const item = document.createElement("div");
    item.className="reviewItem "+(r?"correct":"wrong");
    item.textContent = (i+1)+": "+currentChapter[i][0]+" → "+currentChapter[i][1];
    div.appendChild(item);
  });
  document.getElementById("review").style.display="block";
}

// チャプターに戻る
function backToChapterSelect(){ showChapterSelect(); }

// 同じチャプターをやり直す
function retryChapter(){
  quizIndex=0;
  reviewData=[];
  hideAll();
  document.getElementById("quiz").style.display="block";
  showQuiz();
}
</script>
</body>
</html>